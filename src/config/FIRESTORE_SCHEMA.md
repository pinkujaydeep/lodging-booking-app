# Firestore Database Schema

Complete Firestore database structure for LodgeBook application.

## Collections Overview

```
firestore/
├── lodges/
├── rooms/
├── bookings/
├── users/
├── reviews/
└── roomAvailability/
```

---

## 1. **lodges** Collection

Primary collection for all lodging properties.

### Document Structure

```typescript
{
  // Unique identifiers
  id: string;                    // Auto-generated by Firestore
  slug: string;                  // URL-friendly identifier (e.g., "sunny-beach-resort")

  // Basic Information
  name: string;                  // Lodge name
  description: string;           // Full description
  address: string;              // Street address
  city: string;                 // City name
  country: string;              // Country name
  zipCode: string;              // Postal code
  
  // Location
  latitude: number;             // GPS latitude
  longitude: number;            // GPS longitude
  
  // Media
  imageUrl: string;             // Primary image URL
  
  // Ratings & Reviews
  rating: number;               // Average rating (0-5)
  totalReviews: number;         // Total review count
  
  // Features
  amenities: string[];          // List of amenities
  
  // Management
  ownerId: string;              // References users collection
  isActive: boolean;            // Is accepting bookings
  contactEmail: string;         // Contact email
  contactPhone: string;         // Contact phone
  
  // Timestamps
  createdAt: Timestamp;         // Creation date
  updatedAt: Timestamp;         // Last update date
}
```

### Example Document

```json
{
  "name": "Sunny Beach Resort",
  "slug": "sunny-beach-resort",
  "description": "A beautiful beachfront resort with stunning ocean views...",
  "address": "123 Beach Road",
  "city": "Miami",
  "country": "USA",
  "zipCode": "33139",
  "latitude": 25.7617,
  "longitude": -80.1918,
  "imageUrl": "https://images.unsplash.com/photo-1566073771259-6a8506099945?w=800",
  "rating": 4.7,
  "totalReviews": 156,
  "amenities": ["WiFi", "Pool", "Beach Access", "Restaurant", "Spa"],
  "ownerId": "owner1",
  "isActive": true,
  "contactEmail": "info@sunnybeach.com",
  "contactPhone": "+1-305-555-0100",
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-12-25T00:00:00Z"
}
```

### Indexes

- `slug` (Ascending) - For URL lookups
- `isActive` (Ascending) - For filtering active lodges
- `city` (Ascending) - For location-based filtering
- `rating` (Descending) - For sorting by rating

---

## 2. **rooms** Collection

All rooms across all lodges.

### Document Structure

```typescript
{
  // Unique identifiers
  id: string;                    // Auto-generated by Firestore
  lodgeId: string;              // References lodges collection

  // Room Information
  name: string;                  // Room name (e.g., "Deluxe Ocean View")
  description: string;           // Room description
  
  // Room Type
  roomType: 'single' | 'double' | 'suite' | 'dormitory';
  
  // Capacity
  capacity: number;              // Number of guests per room
  
  // Pricing
  basePrice: number;             // Base price per night
  currency: string;              // Currency code (USD, EUR, etc.)
  
  // Features
  amenities: string[];           // Room amenities
  
  // Media
  imageUrls: string[];           // Multiple room images
  
  // Availability
  totalRooms: number;            // Total rooms of this type
  
  // Timestamps
  createdAt: Timestamp;          // Creation date
  updatedAt: Timestamp;          // Last update date
}
```

### Example Document

```json
{
  "lodgeId": "lodge-doc-id",
  "name": "Deluxe Ocean View Room",
  "description": "Spacious room with panoramic ocean views...",
  "roomType": "double",
  "capacity": 2,
  "basePrice": 150,
  "currency": "USD",
  "amenities": ["WiFi", "Ocean View", "Balcony", "Air Conditioning"],
  "imageUrls": [
    "https://images.unsplash.com/photo-1631049307264-da0ec9d70304?w=600",
    "https://images.unsplash.com/photo-1566195992212-91cabc39d44d?w=600"
  ],
  "totalRooms": 25,
  "createdAt": "2024-01-15T00:00:00Z",
  "updatedAt": "2024-12-25T00:00:00Z"
}
```

### Indexes

- `lodgeId` (Ascending) - For fetching rooms by lodge
- `roomType` (Ascending) - For filtering by room type
- `basePrice` (Ascending) - For price-based filtering

---

## 3. **bookings** Collection

All guest bookings and reservations.

### Document Structure

```typescript
{
  // Unique identifiers
  id: string;                    // Auto-generated by Firestore
  
  // References
  userId: string;               // References users collection
  lodgeId: string;              // References lodges collection
  roomId: string;               // References rooms collection
  
  // Booking Dates
  checkInDate: Timestamp;       // Check-in date
  checkOutDate: Timestamp;      // Check-out date
  
  // Guest Information
  numberOfGuests: number;       // Number of guests
  numberOfRooms: number;        // Number of rooms booked
  
  // Pricing
  totalPrice: number;           // Total booking price
  
  // Status
  status: 'pending' | 'confirmed' | 'checked_in' | 'checked_out' | 'cancelled';
  paymentStatus: 'pending' | 'completed' | 'failed' | 'refunded';
  
  // Payment
  stripePaymentIntentId?: string; // Stripe payment intent ID
  
  // Additional Info
  specialRequests?: string;     // Guest special requests
  guestNotes?: string;          // Internal notes
  
  // Timestamps
  createdAt: Timestamp;         // Booking creation date
  updatedAt: Timestamp;         // Last update date
}
```

### Example Document

```json
{
  "userId": "user-doc-id",
  "lodgeId": "lodge-doc-id",
  "roomId": "room-doc-id",
  "checkInDate": "2024-12-26T15:00:00Z",
  "checkOutDate": "2024-12-28T11:00:00Z",
  "numberOfGuests": 2,
  "numberOfRooms": 1,
  "totalPrice": 450,
  "status": "confirmed",
  "paymentStatus": "completed",
  "stripePaymentIntentId": "pi_1234567890",
  "specialRequests": "Early check-in if possible",
  "createdAt": "2024-12-25T10:30:00Z",
  "updatedAt": "2024-12-25T10:35:00Z"
}
```

### Indexes

- `userId` (Ascending) - For fetching user's bookings
- `lodgeId` (Ascending) - For lodge booking history
- `status` (Ascending) - For filtering by status
- `checkInDate` (Ascending) - For date-based queries
- `paymentStatus` (Ascending) - For payment filtering

---

## 4. **users** Collection

Guest and manager user profiles.

### Document Structure

```typescript
{
  // Unique identifiers
  id: string;                   // Firebase Auth UID
  
  // Basic Information
  email: string;                // User email
  displayName: string;          // Full name
  
  // Profile
  photoURL?: string;            // Profile picture URL
  phone?: string;               // Phone number
  
  // Address
  address?: string;             // Street address
  city?: string;                // City
  country?: string;             // Country
  zipCode?: string;             // Postal code
  
  // Role
  role: 'customer' | 'admin' | 'lodge_manager';
  lodgeId?: string;             // If lodge_manager, which lodge
  
  // Account
  isVerified: boolean;          // Email verified
  isActive: boolean;            // Account active
  
  // Timestamps
  createdAt: Timestamp;         // Account creation date
  updatedAt: Timestamp;         // Last update date
}
```

### Example Document (Guest)

```json
{
  "email": "guest@example.com",
  "displayName": "John Doe",
  "photoURL": "https://...",
  "phone": "+1-555-0100",
  "address": "456 Main Street",
  "city": "New York",
  "country": "USA",
  "zipCode": "10001",
  "role": "customer",
  "isVerified": true,
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-12-25T00:00:00Z"
}
```

### Example Document (Lodge Manager)

```json
{
  "email": "manager@sunnybeach.com",
  "displayName": "Jane Manager",
  "photoURL": "https://...",
  "phone": "+1-305-555-0100",
  "role": "lodge_manager",
  "lodgeId": "lodge-doc-id",
  "isVerified": true,
  "isActive": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-12-25T00:00:00Z"
}
```

### Indexes

- `email` (Ascending) - For user lookup
- `role` (Ascending) - For role-based filtering
- `isActive` (Ascending) - For active user filtering

---

## 5. **reviews** Collection

Guest reviews and ratings for lodges.

### Document Structure

```typescript
{
  // Unique identifiers
  id: string;                   // Auto-generated by Firestore
  
  // References
  lodgeId: string;              // References lodges collection
  userId: string;               // References users collection
  bookingId: string;            // References bookings collection
  
  // Review Content
  rating: number;               // Rating 1-5
  title: string;                // Review title
  comment: string;              // Review text
  
  // Review Details
  cleanliness: number;          // Cleanliness rating 1-5
  comfort: number;              // Comfort rating 1-5
  service: number;              // Service rating 1-5
  value: number;                // Value rating 1-5
  
  // Admin
  verified: boolean;            // Verified purchase
  helpful: number;              // Helpful count
  
  // Timestamps
  createdAt: Timestamp;         // Review date
  updatedAt: Timestamp;         // Last update
}
```

### Example Document

```json
{
  "lodgeId": "lodge-doc-id",
  "userId": "user-doc-id",
  "bookingId": "booking-doc-id",
  "rating": 5,
  "title": "Amazing beachfront resort!",
  "comment": "Had the best time at this resort. Great service, beautiful views...",
  "cleanliness": 5,
  "comfort": 5,
  "service": 5,
  "value": 4,
  "verified": true,
  "helpful": 42,
  "createdAt": "2024-12-24T00:00:00Z",
  "updatedAt": "2024-12-25T00:00:00Z"
}
```

### Indexes

- `lodgeId` (Ascending) - For lodge reviews
- `rating` (Descending) - For sorting reviews
- `verified` (Ascending) - For verified reviews only

---

## 6. **roomAvailability** Collection

Track room availability and occupancy.

### Document Structure

```typescript
{
  // Unique identifiers
  id: string;                   // Auto-generated by Firestore
  
  // References
  roomId: string;               // References rooms collection
  lodgeId: string;              // References lodges collection
  
  // Availability
  date: Timestamp;              // Date of availability
  available: number;            // Number of rooms available
  booked: number;               // Number of rooms booked
  
  // Pricing (Optional - for seasonal pricing)
  priceOverride?: number;       // Override base price for this date
  seasonTag?: string;           // Season identifier
  
  // Status
  blocked: boolean;             // Is this date blocked
  blockReason?: string;         // Why it's blocked
}
```

### Example Document

```json
{
  "roomId": "room-doc-id",
  "lodgeId": "lodge-doc-id",
  "date": "2024-12-26T00:00:00Z",
  "available": 20,
  "booked": 5,
  "priceOverride": 200,
  "seasonTag": "holiday",
  "blocked": false
}
```

### Indexes

- `roomId` (Ascending), `date` (Ascending) - Compound index for availability lookup
- `date` (Ascending) - For date-based availability queries

---

## Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow anyone to read public lodges
    match /lodges/{document=**} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.customClaims.role == 'admin';
    }
    
    // Allow anyone to read room information
    match /rooms/{document=**} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.customClaims.role == 'admin';
    }
    
    // Users can read/write their own bookings
    match /bookings/{booking} {
      allow read: if request.auth != null && 
                     (request.auth.uid == resource.data.userId ||
                      request.auth.customClaims.role == 'admin');
      allow create: if request.auth != null;
      allow write: if request.auth != null && request.auth.customClaims.role == 'admin';
    }
    
    // Users can read/write their own profile
    match /users/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if request.auth != null && request.auth.uid == uid;
      allow create: if request.auth != null && request.auth.uid == uid;
    }
    
    // Anyone can read reviews
    match /reviews/{document=**} {
      allow read: if true;
      allow create: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Read availability, controlled write
    match /roomAvailability/{document=**} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.customClaims.role == 'admin';
    }
  }
}
```

---

## Data Types Reference

```typescript
// Common field types in Firestore
Timestamp     // ISO 8601 date/time
string        // Text
number        // Integer or decimal
boolean       // True/false
array         // List of values
```

---

## Creating Collections

### Via Firebase Console

1. Go to Firestore Database
2. Click "Start Collection"
3. Enter collection ID
4. Add first document (optional)

### Via Code (src/lib/db.ts)

```typescript
import { collection, addDoc, Timestamp } from 'firebase/firestore';

export const createLodge = async (data) => {
  return addDoc(collection(db, 'lodges'), {
    ...data,
    createdAt: Timestamp.now(),
    updatedAt: Timestamp.now(),
  });
};
```

---

## Querying Examples

### Get all active lodges

```typescript
const q = query(
  collection(db, 'lodges'),
  where('isActive', '==', true),
  orderBy('createdAt', 'desc')
);
```

### Get rooms by lodge

```typescript
const q = query(
  collection(db, 'rooms'),
  where('lodgeId', '==', lodgeId)
);
```

### Get user's bookings

```typescript
const q = query(
  collection(db, 'bookings'),
  where('userId', '==', userId),
  orderBy('checkInDate', 'desc')
);
```

### Get lodge by slug

```typescript
const q = query(
  collection(db, 'lodges'),
  where('slug', '==', slug)
);
```

---

## Data Migration Tips

### Bulk Import

Use Firebase Admin SDK with JSON files:

```typescript
const admin = require('firebase-admin');
const db = admin.firestore();

async function importLodges(jsonData) {
  for (const lodge of jsonData) {
    await db.collection('lodges').add(lodge);
  }
}
```

### Adding Missing Fields

Update existing documents:

```typescript
const lodges = await getDocs(collection(db, 'lodges'));
for (const doc of lodges.docs) {
  if (!doc.data().slug) {
    const slug = doc.data().name.toLowerCase().replace(/\s+/g, '-');
    await updateDoc(doc.ref, { slug });
  }
}
```

---

## Performance Optimization

### Indexes to Create

1. `lodges`: slug (ascending)
2. `lodges`: city, isActive (compound)
3. `rooms`: lodgeId, roomType (compound)
4. `bookings`: userId, checkInDate (compound)
5. `reviews`: lodgeId, rating (compound)

### Query Optimization

- Always filter before sorting
- Use compound indexes for multiple conditions
- Limit results when possible
- Cache frequently accessed data

---

## Backup & Recovery

### Export Data

```bash
gcloud firestore export gs://bucket-name/backup-name
```

### Restore Data

```bash
gcloud firestore import gs://bucket-name/backup-name
```

---

## Related Files

- `src/lib/db.ts` - All database operations
- `src/lib/types.ts` - TypeScript interfaces
- `src/lib/firebase.ts` - Firebase initialization
- `docs/` - Documentation folder

---

**Last Updated:** December 25, 2025  
**Version:** 1.0
